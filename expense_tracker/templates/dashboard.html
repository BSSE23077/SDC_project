{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- Top row: title left, filters right -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 gap-4">
        <h1 class="text-4xl font-bold text-gray-900">Dashboard</h1>

        <form method="GET" action="{{ url_for('dashboard') }}" class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">From date</label>
                <input type="date" name="start_date"
                       value="{{ request.args.get('start_date','') }}"
                       class="border rounded-lg px-3 py-2 text-sm">
            </div>

            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">To date</label>
                <input type="date" name="end_date"
                       value="{{ request.args.get('end_date','') }}"
                       class="border rounded-lg px-3 py-2 text-sm">
            </div>

            <button class="h-10 px-5 bg-gray-900 text-white rounded-lg text-sm font-semibold hover:bg-gray-800">
                Show
            </button>
        </form>
    </div>


    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <!-- Total Spent -->
        <div class="bg-white border-l-4 border-red-600 p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Total Spent (This Month)</p>
                    <h3 class="text-4xl font-bold text-gray-900 mt-2">${{ "%.2f"|format(total_spent) }}</h3>
                </div>
                <i class="fas fa-arrow-down text-5xl text-red-600 opacity-20"></i>
            </div>
        </div>
        
        <!-- Budget -->
        <div class="bg-white border-l-4 border-gray-900 p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Monthly Budget</p>
                    <h3 class="text-4xl font-bold text-gray-900 mt-2">${{ "%.2f"|format(budget_amount) }}</h3>
                </div>
                <i class="fas fa-wallet text-5xl text-gray-900 opacity-20"></i>
            </div>
        </div>
        
        <!-- Remaining -->
        <div class="bg-white border-l-4 border-green-600 p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Remaining</p>
                    <h3 class="text-4xl font-bold {% if remaining < 0 %}text-red-600{% else %}text-gray-900{% endif %} mt-2">
                        ${{ "%.2f"|format(remaining) }}
                    </h3>
                </div>
                <i class="fas fa-piggy-bank text-5xl text-green-600 opacity-20"></i>
            </div>
        </div>
    </div>
    
    <!-- Alert -->
    {% if remaining < 0 %}
    <div class="bg-red-50 border-l-4 border-red-600 text-red-800 p-5 mb-8 rounded-r shadow">
        <p class="font-bold text-lg">⚠️ Budget Exceeded</p>
        <p class="mt-1">You've overspent by ${{ "%.2f"|format(total_spent - budget_amount) }}</p>
    </div>
    {% endif %}

<!-- Category Chart + Totals (centered, smaller) -->
<div class="flex justify-center mt-4">
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 w-full max-w-4xl">
        <h2 class="text-xl font-bold text-gray-900 mb-3 text-center">Spending by Category (This Month)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
            <div class="max-w-xs mx-auto">
                <canvas id="categoryChart" height="90"></canvas>
            </div>
            <div>
                <h3 class="text-md font-semibold text-gray-900 mb-2">Category Totals</h3>
                {% if labels %}
                <ul class="space-y-1 text-sm text-gray-700">
                    {% for i in range(labels|length) %}
                    <li class="flex justify-between bg-gray-50 px-3 py-1.5 rounded">
                        <span>{{ labels[i] }}</span>
                        <span class="font-semibold">${{ "%.2f"|format(values[i]) }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-gray-500 text-sm">No expenses recorded this month yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <!-- Recent Expenses -->
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 mt-8">
        <div class="px-6 py-5 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900">Recent Expenses</h2>
        </div>
        
        {% if expenses %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Merchant</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Description</th>
                        <th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for expense in expenses[-10:] %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ expense.date.strftime('%Y-%m-%d') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                {{ expense.category }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            {{ expense.merchant }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ expense.description or '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-gray-900">
                            ${{ "%.2f"|format(expense.amount) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm space-x-2">
                            <a href="{{ url_for('edit_expense', expense_id=expense.id) }}"
                               class="inline-flex items-center px-3 py-1 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-pen text-xs mr-1"></i> Edit
                            </a>
                            <form method="POST" action="{{ url_for('delete_expense', expense_id=expense.id) }}"
                                  style="display:inline;"
                                  onsubmit="return confirm('Are you sure you want to delete this expense?');">
                                <button type="submit"
                                        class="inline-flex items-center px-3 py-1 border border-red-300 rounded-lg text-red-600 hover:bg-red-50">
                                    <i class="fas fa-trash text-xs mr-1"></i> Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-12 text-center">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">No expenses yet. Add your first expense to get started.</p>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ labels|tojson }};
    const values = {{ values|tojson }};

    const ctx = document.getElementById('categoryChart').getContext('2d');

    if (labels.length > 0) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#77a2fdff','#012f57ff','#EF4444',
                        '#10B981','#3B82F6','#F59E0B','#6366F1'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 10, font: { size: 11 } }
                    }
                },
                layout: { padding: 0 }
            }
        });
    }
</script>
{% endblock %}
